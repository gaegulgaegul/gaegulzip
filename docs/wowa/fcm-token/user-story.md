# 사용자 스토리: FCM 토큰 저장 (FCM Token Registration)

## 개요

사용자가 앱에 로그인하면 자동으로 푸시 알림을 받을 수 있도록 디바이스 토큰이 서버에 등록되고, 로그아웃 시 비활성화되며, 토큰 갱신 시 자동으로 재등록되는 기능입니다. 이를 통해 사용자는 앱을 사용하지 않을 때에도 중요한 정보를 실시간으로 받을 수 있습니다.

**비즈니스 가치**:
- 사용자 재참여율 증가 (푸시 알림을 통한 앱 재방문 유도)
- 중요 정보 전달 보장 (공지사항, 이벤트, 개인화 메시지)
- 사용자 경험 개선 (로그인 시 자동 등록, 로그아웃 시 자동 비활성화)

---

## 사용자 스토리

### US-1: 로그인 후 자동 토큰 등록
- **As a** 앱 사용자
- **I want to** 로그인 완료 후 자동으로 푸시 알림을 받을 수 있도록 설정되고
- **So that** 수동으로 설정하지 않아도 앱의 중요한 알림을 즉시 받을 수 있다

### US-1.1: 자동 로그인 시 토큰 등록
- **As a** 이전에 로그인한 적이 있는 사용자
- **I want to** 앱을 다시 실행했을 때 자동 로그인 상태라면 FCM 토큰이 서버에 등록되고
- **So that** 매번 수동 로그인하지 않아도 앱 재시작 시 즉시 알림을 받을 수 있다

### US-2: 토큰 갱신 시 자동 재등록
- **As a** 앱 사용자
- **I want to** 디바이스 토큰이 갱신되면 자동으로 서버에 재등록되고
- **So that** 토큰 만료나 시스템 변경에도 계속해서 알림을 받을 수 있다

### US-3: 로그아웃 시 알림 중단
- **As a** 앱 사용자
- **I want to** 로그아웃하면 해당 디바이스로 푸시 알림이 더 이상 전송되지 않고
- **So that** 로그아웃 후에는 개인정보와 관련된 알림을 받지 않을 수 있다

### US-4: 권한 거부 시에도 앱 정상 동작
- **As a** 앱 사용자
- **I want to** 푸시 알림 권한을 거부해도 앱의 다른 기능은 정상적으로 사용할 수 있고
- **So that** 알림을 원하지 않는 경우에도 앱을 제한 없이 사용할 수 있다

### US-5: 다중 디바이스 지원
- **As a** 여러 디바이스를 사용하는 사용자
- **I want to** 동일 계정으로 여러 디바이스에서 로그인하면 모든 디바이스에서 알림을 받을 수 있고
- **So that** 어떤 디바이스를 사용하더라도 중요한 알림을 놓치지 않을 수 있다

### US-6: 앱 재설치 후 알림 재활성화
- **As a** 앱을 재설치한 사용자
- **I want to** 재설치 후 로그인하면 자동으로 푸시 알림이 다시 활성화되고
- **So that** 재설정 없이 이전과 동일하게 알림을 받을 수 있다

---

## 사용자 시나리오

### 시나리오 1: 최초 로그인 후 토큰 등록 (정상 플로우)
1. 사용자가 앱을 설치하고 소셜 로그인(카카오, 네이버 등)을 완료한다
2. 시스템이 푸시 알림 권한을 요청한다 (iOS의 경우 시스템 다이얼로그)
3. 사용자가 권한을 허용한다
4. 시스템이 FCM 디바이스 토큰을 자동으로 획득한다
5. 시스템이 토큰을 서버에 자동 등록한다 (사용자 ID, 토큰, 플랫폼, 디바이스 ID)
6. 서버가 토큰을 저장하고 활성 상태로 설정한다
7. 결과: 사용자는 이제 푸시 알림을 받을 수 있다

### 시나리오 1.1: 자동 로그인 시 토큰 등록 (정상 플로우)
1. 사용자가 이전에 로그인한 상태로 앱을 종료했다
2. 사용자가 앱을 다시 실행한다
3. 시스템이 저장된 인증 토큰으로 자동 로그인 상태를 확인한다
4. 시스템이 FCM 디바이스 토큰을 획득한다
5. 시스템이 인증 상태를 확인하고 토큰을 서버에 등록한다
6. 서버가 토큰을 저장(Upsert)하고 활성 상태로 설정한다
7. 결과: 자동 로그인 사용자도 즉시 푸시 알림을 받을 수 있다

### 시나리오 2: 권한 거부 후 계속 사용 (대안 플로우)
1. 사용자가 로그인을 완료한다
2. 시스템이 푸시 알림 권한을 요청한다
3. 사용자가 권한을 거부한다
4. 시스템이 토큰 등록을 시도하지 않고 조용히 스킵한다
5. 앱의 다른 기능(홈, 설정 등)은 정상적으로 표시된다
6. 결과: 사용자는 푸시 알림 없이 앱을 사용할 수 있다

### 시나리오 3: 토큰 갱신 시 자동 재등록 (정상 플로우)
1. 사용자가 앱을 사용 중이거나 백그라운드에 두고 있다
2. FCM 시스템이 디바이스 토큰을 갱신한다 (시스템 재설치, 앱 재설치 등)
3. 시스템이 토큰 갱신 이벤트를 감지한다
4. 시스템이 새로운 토큰을 자동으로 서버에 재등록한다
5. 서버가 기존 토큰을 새 토큰으로 갱신한다
6. 결과: 사용자는 계속해서 알림을 받을 수 있다

### 시나리오 4: 로그아웃 시 토큰 비활성화 (정상 플로우)
1. 사용자가 앱 설정에서 로그아웃 버튼을 누른다
2. 시스템이 로그아웃 API를 호출한다 (토큰 폐기)
3. 시스템이 서버에 디바이스 토큰 비활성화를 요청한다
4. 서버가 해당 디바이스 토큰을 비활성 상태로 변경한다
5. 시스템이 로컬 인증 정보를 삭제하고 로그인 화면으로 이동한다
6. 결과: 해당 디바이스로는 더 이상 푸시 알림이 전송되지 않는다

### 시나리오 5: 여러 디바이스에서 로그인 (정상 플로우)
1. 사용자가 아이폰에서 로그인한다
2. 시스템이 아이폰의 FCM 토큰을 서버에 등록한다
3. 사용자가 같은 계정으로 안드로이드 태블릿에서 로그인한다
4. 시스템이 태블릿의 FCM 토큰을 서버에 등록한다
5. 서버에서 푸시 알림을 발송한다
6. 아이폰과 태블릿 모두 알림을 수신한다
7. 결과: 모든 디바이스에서 알림을 받을 수 있다

### 시나리오 6: 앱 재설치 후 재등록 (정상 플로우)
1. 사용자가 앱을 삭제한다
2. 서버에 등록된 이전 디바이스 토큰은 그대로 유지된다 (소프트 삭제)
3. 사용자가 앱을 재설치하고 로그인한다
4. 시스템이 새로운 FCM 토큰을 획득한다
5. 시스템이 새 토큰을 서버에 등록한다
6. 서버가 기존 토큰을 갱신하거나 새 토큰을 추가한다
7. 결과: 사용자는 재설치 후에도 알림을 받을 수 있다

### 시나리오 7: 네트워크 오류 시 재시도 (대안 플로우)
1. 사용자가 로그인을 완료한다
2. 시스템이 FCM 토큰을 획득하고 서버에 등록을 시도한다
3. 네트워크 연결이 불안정하여 요청이 실패한다
4. 시스템이 백그라운드에서 재시도를 준비한다 (로컬에 토큰 임시 저장)
5. 네트워크가 복구되면 자동으로 재시도한다
6. 등록에 성공하거나 실패해도 앱의 다른 기능은 정상 동작한다
7. 결과: 네트워크가 복구되면 알림을 받을 수 있다

### 시나리오 8: 권한 거부 후 설정에서 활성화 (대안 플로우)
1. 사용자가 처음에 푸시 알림 권한을 거부했다
2. 나중에 알림을 받고 싶어한다
3. 사용자가 앱 설정 또는 시스템 설정에서 알림 권한을 허용한다
4. 앱으로 돌아올 때 시스템이 권한 변경을 감지한다
5. 시스템이 FCM 토큰을 획득하고 서버에 등록한다
6. 결과: 사용자는 나중에라도 알림을 활성화할 수 있다

---

## 인수 조건 (Acceptance Criteria)

### 토큰 등록
- [ ] 사용자가 로그인하면 자동으로 FCM 토큰 획득을 시도한다
- [ ] 자동 로그인(앱 재시작) 시에도 인증 상태라면 FCM 토큰을 서버에 등록한다
- [ ] 푸시 알림 권한이 허용되면 토큰을 서버에 자동 등록한다
- [ ] 토큰 등록 시 사용자 ID, 토큰, 플랫폼(ios/android), 디바이스 ID가 서버에 전송된다
- [ ] 서버가 토큰을 저장하고 활성 상태로 설정한다
- [ ] 동일한 사용자가 이미 같은 토큰을 등록했다면 갱신한다 (중복 생성 방지)

### 토큰 갱신
- [ ] FCM 토큰이 갱신되면 자동으로 감지한다
- [ ] 갱신된 토큰을 즉시 서버에 재등록한다
- [ ] 서버가 기존 토큰을 새 토큰으로 업데이트한다

### 로그아웃 시 비활성화
- [ ] 로그아웃 시 서버에 디바이스 토큰 비활성화를 요청한다
- [ ] 서버가 해당 토큰을 비활성 상태로 변경한다 (삭제하지 않음)
- [ ] 비활성화된 토큰으로는 푸시 알림이 전송되지 않는다

### 권한 처리
- [ ] 푸시 알림 권한 거부 시 토큰 등록을 시도하지 않는다
- [ ] 권한 거부 후에도 앱의 다른 기능은 정상 동작한다
- [ ] 권한 상태가 변경되면 자동으로 감지하고 토큰 등록을 재시도한다

### 다중 디바이스
- [ ] 동일 사용자가 여러 디바이스에서 로그인하면 모든 디바이스 토큰이 등록된다
- [ ] 각 디바이스 토큰은 독립적으로 관리된다
- [ ] 한 디바이스에서 로그아웃해도 다른 디바이스는 영향받지 않는다

### 에러 처리
- [ ] 네트워크 오류 시 토큰 등록 실패해도 앱은 정상 동작한다
- [ ] 서버 오류 시 조용히 실패하고 사용자에게 에러를 표시하지 않는다
- [ ] 토큰 획득 실패 시 로그만 기록하고 앱은 계속 실행된다

### 재설치 및 복구
- [ ] 앱 재설치 후 로그인하면 새 토큰이 자동 등록된다
- [ ] 이전 토큰이 서버에 남아있어도 중복 없이 갱신된다

---

## 엣지 케이스

- **권한 요청 무시**: 사용자가 권한 다이얼로그를 무시하고 닫으면 앱은 계속 실행되고, 다음 앱 재시작 시 다시 권한을 요청하지 않는다 (시스템 정책에 따름)
- **토큰 획득 실패**: FCM 토큰을 획득할 수 없으면 (네트워크 오류, FCM 서비스 장애) 조용히 실패하고 로그만 기록한다
- **서버 등록 실패 (401 Unauthorized)**: 인증 토큰이 만료된 경우 토큰 갱신 후 재시도한다
- **서버 등록 실패 (5xx)**: 서버 오류 시 백그라운드에서 재시도하고, 실패해도 앱은 정상 동작한다
- **빠른 로그인/로그아웃 반복**: 짧은 시간에 여러 번 로그인/로그아웃하면 각 요청이 순차적으로 처리되고 최종 상태가 올바르게 반영된다
- **토큰 갱신 중 로그아웃**: 토큰 갱신 요청과 로그아웃이 동시에 발생하면 로그아웃 요청이 우선시된다
- **동일 디바이스에서 다른 계정 로그인**: 이전 계정의 토큰은 비활성화되고 새 계정의 토큰이 등록된다
- **네트워크 복구 전 앱 종료**: 토큰 등록 재시도 중 앱이 종료되면 다음 앱 실행 시 다시 등록을 시도한다
- **FCM 토큰이 null 반환**: iOS에서 APNS 토큰이 준비되지 않아 FCM 토큰이 null이면 일정 시간 대기 후 재시도한다
- **로그인 완료 후 즉시 권한 거부**: 권한을 거부하면 토큰 등록을 건너뛰고 앱은 정상 실행된다

---

## 비즈니스 규칙

- **토큰 저장 방식**: 서버는 (사용자 ID, 앱 ID, 토큰) 조합으로 유니크 제약을 두고 Upsert 방식으로 저장한다
- **토큰 활성 상태**: 등록 시 활성(isActive=true), 로그아웃 시 비활성(isActive=false)으로 변경한다
- **비활성 토큰 제외**: 푸시 알림 발송 시 비활성 토큰은 자동으로 제외된다
- **토큰 갱신 시점**: FCM 토큰 갱신 이벤트 발생 시 즉시 서버에 재등록한다
- **로그인 시 등록 시점**: 소셜 로그인 완료 및 JWT 토큰 획득 직후, 푸시 알림 권한이 허용된 경우에만 등록한다
- **로그아웃 시 비활성화 시점**: 로그아웃 API 호출 직전 또는 직후 디바이스 토큰 비활성화를 요청한다
- **다중 디바이스 제한 없음**: 한 사용자가 등록할 수 있는 디바이스 토큰 개수에 제한을 두지 않는다
- **앱별 토큰 격리**: 각 앱(appCode)은 독립적인 Firebase 프로젝트를 사용하며, 토큰은 앱별로 격리된다

---

## 필요한 데이터

### 토큰 등록 요청 (모바일 → 서버)
| 데이터 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| token | String | ✅ | FCM 디바이스 토큰 (1~500자) |
| platform | Enum | ✅ | `ios` / `android` / `web` |
| deviceId | String | ❌ | 디바이스 고유 식별자 (선택) |

### 토큰 등록 응답 (서버 → 모바일)
| 데이터 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| id | Integer | ✅ | 등록된 토큰의 고유 ID |
| token | String | ✅ | 저장된 FCM 토큰 |
| platform | String | ✅ | 플랫폼 |
| isActive | Boolean | ✅ | 활성 상태 |
| lastUsedAt | Timestamp | ✅ | 마지막 사용 시각 |
| createdAt | Timestamp | ✅ | 생성 시각 |

### 토큰 비활성화 요청 (모바일 → 서버)
| 데이터 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| id | Integer | ✅ | 비활성화할 토큰 ID |

### 내부 처리 데이터
| 데이터 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| userId | Integer | ✅ | 인증 토큰에서 추출한 사용자 ID |
| appId | Integer | ✅ | 인증 토큰에서 추출한 앱 ID |
| appCode | String | ✅ | 앱 식별 코드 (예: "wowa") |

---

## 비기능 요구사항

### 성능
- **토큰 등록 시간**: 네트워크 정상 상태에서 3초 이내 완료
- **토큰 획득 시간**: FCM 토큰 획득은 1~2초 이내 (iOS APNS 대기 포함)
- **백그라운드 처리**: 토큰 등록/갱신은 백그라운드 작업으로 처리하여 UI 블로킹 방지

### 보안
- **인증 필수**: 토큰 등록 API는 JWT 인증이 필수다
- **토큰 보안**: 디바이스 토큰은 서버에서만 관리하고 로그에는 일부만 노출한다 (예: 앞 20자)
- **권한 검증**: 다른 사용자의 토큰을 등록하거나 비활성화할 수 없다

### 안정성
- **조용한 실패**: 토큰 등록 실패 시 사용자에게 에러를 표시하지 않고 로그만 기록한다
- **재시도 정책**: 네트워크 오류 시 백그라운드에서 자동 재시도한다 (Exponential Backoff)
- **상태 동기화**: 토큰 등록/비활성화 요청은 멱등성을 보장한다 (같은 요청을 여러 번 보내도 결과가 동일)

### 접근성
- **권한 안내**: 푸시 알림 권한 요청 시 사용자에게 알림의 가치를 명확히 안내한다 (시스템 다이얼로그 전 커스텀 안내 가능)
- **설정 화면 연결**: 권한 거부 후 사용자가 설정에서 권한을 활성화할 수 있도록 안내를 제공한다

### 로깅
- **토큰 등록 성공**: INFO 레벨로 사용자 ID, 플랫폼, 토큰 일부 기록
- **토큰 등록 실패**: ERROR 레벨로 사용자 ID, 에러 메시지, 스택 트레이스 기록
- **토큰 갱신**: INFO 레벨로 토큰 갱신 이벤트 기록
- **권한 거부**: WARN 레벨로 권한 거부 이벤트 기록

### 에러 메시지
- **네트워크 오류**: 사용자에게 표시하지 않음 (백그라운드 재시도)
- **서버 오류**: 사용자에게 표시하지 않음 (로그만 기록)
- **권한 거부**: "알림을 받으려면 설정에서 권한을 허용해 주세요" (설정 화면 연결)
- **토큰 획득 실패**: 사용자에게 표시하지 않음 (로그만 기록)

---

## 기술적 제약사항

- **서버**: 이미 구현 완료 (`POST /push/devices`, `DELETE /push/devices/:id`)
- **모바일 SDK**: 부분 구현 완료 (`PushService`, `PushApiClient`)
- **누락된 부분**: PushService와 로그인/로그아웃 플로우 연동, 토큰 갱신 리스너에서 서버 API 호출
- **FCM 인증**: 서버에 Firebase Admin SDK 인증 정보 설정 필요 (`apps` 테이블의 `fcmProjectId`, `fcmPrivateKey`, `fcmClientEmail`)
- **플랫폼별 설정**: iOS/Android 각각 `GoogleService-Info.plist`, `google-services.json` 필요

---

## 스코프

### Phase 1 (현재 기능)
- [x] 서버: 디바이스 토큰 CRUD API (`POST /push/devices`, `DELETE /push/devices/:id`)
- [x] 서버: 토큰 Upsert 방식 저장 (중복 방지)
- [x] 모바일: PushService 초기화 및 FCM 토큰 획득
- [x] 모바일: 로그인 후 토큰 서버 등록
- [ ] 모바일: 자동 로그인 시 토큰 서버 등록 (ever 타이밍 버그 수정)
- [x] 모바일: 토큰 갱신 시 서버 재등록
- [x] 모바일: 로그아웃 시 토큰 비활성화

### Phase 2 (향후)
- [ ] 권한 거부 후 설정 화면 연결 (커스텀 안내)
- [ ] 토큰 등록 실패 시 로컬 큐에 저장 후 재시도
- [ ] 토큰 등록 상태 UI 표시 (설정 화면)
- [ ] 디바이스 목록 조회 및 개별 비활성화 (사용자 UI)

### Out of Scope
- ❌ 푸시 알림 수신 및 표시 (별도 기능)
- ❌ 알림 목록 조회 및 읽음 처리 (별도 기능)
- ❌ 알림 발송 기능 (서버 관리자 기능)
- ❌ 알림 콘텐츠 관리 (CMS)

---

## 참고 자료

- 기존 푸시 알림 사용자 스토리: [`docs/wowa/push-alert/user-story.md`](../push-alert/user-story.md)
- FCM 푸시 알림 구현 분석: [`docs/core/fcm-push-notification.md`](../../core/fcm-push-notification.md)
- 서버 카탈로그: [`docs/wowa/server-catalog.md`](../server-catalog.md)
- 모바일 카탈로그: [`docs/wowa/mobile-catalog.md`](../mobile-catalog.md)
