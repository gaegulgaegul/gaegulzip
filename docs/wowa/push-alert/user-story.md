# 사용자 스토리: 푸시 알림 (Push Notification)

## 개요

사용자가 앱을 사용하지 않을 때에도 중요한 정보를 실시간으로 전달받고, 앱 내에서 이전에 받은 알림 내역을 확인하며, 읽지 않은 알림을 관리할 수 있는 기능입니다. 이를 통해 사용자 재참여(Re-engagement)를 높이고, 중요한 정보의 전달률을 향상시킵니다.

**비즈니스 가치**:
- 사용자 재방문율 증가 (푸시를 통한 앱 재실행 유도)
- 중요 정보 전달 보장 (공지, 이벤트, 개인화 메시지)
- 사용자 경험 개선 (알림 히스토리 제공으로 놓친 정보 확인 가능)

## 사용자 스토리

### US-1: 디바이스 푸시 알림 수신 설정
- **As a** 앱 사용자
- **I want to** 앱 설치 후 푸시 알림을 받을 수 있도록 설정하고
- **So that** 앱을 사용하지 않을 때에도 중요한 정보를 놓치지 않을 수 있다

### US-2: 포그라운드 알림 확인
- **As a** 앱 사용 중인 사용자
- **I want to** 앱을 사용하는 도중에도 새로운 알림이 도착하면 화면에 표시되고
- **So that** 현재 화면을 벗어나지 않고도 알림을 즉시 확인할 수 있다

### US-3: 백그라운드/종료 상태 알림 수신
- **As a** 앱을 백그라운드에 두거나 종료한 사용자
- **I want to** 시스템 알림 센터를 통해 푸시 알림을 받고
- **So that** 앱을 직접 열지 않고도 새로운 소식을 확인할 수 있다

### US-4: 알림 탭 시 관련 화면 이동
- **As a** 알림을 받은 사용자
- **I want to** 알림을 탭했을 때 알림과 관련된 화면으로 바로 이동하고
- **So that** 추가 탐색 없이 원하는 정보에 빠르게 접근할 수 있다

### US-5: 앱 내 알림 목록 확인
- **As a** 앱 사용자
- **I want to** 현재 사용 중인 앱에서 발송된 알림만 시간순으로 확인하고
- **So that** 다른 앱의 알림과 섞이지 않고, 해당 앱의 놓친 알림을 다시 볼 수 있다

### US-6: 알림 읽음 상태 관리
- **As a** 앱 사용자
- **I want to** 읽지 않은 알림과 읽은 알림을 구분하여 표시하고
- **So that** 아직 확인하지 않은 알림을 빠르게 파악할 수 있다

### US-7: 알림 개별 읽음 처리
- **As a** 앱 사용자
- **I want to** 알림 목록에서 특정 알림을 탭하거나 확인했을 때 자동으로 읽음 처리되고
- **So that** 수동으로 읽음 표시를 하지 않아도 자동으로 관리된다

### US-8: 디바이스 토큰 자동 갱신
- **As a** 앱 사용자
- **I want to** 앱 재설치나 시스템 변경 시 자동으로 푸시 알림 설정이 유지되고
- **So that** 다시 설정하지 않아도 계속해서 알림을 받을 수 있다

### US-9: 관리자의 알림 발송
- **As a** 시스템 관리자 또는 마케터
- **I want to** 특정 사용자 또는 전체 사용자에게 푸시 알림을 발송하고
- **So that** 공지사항, 이벤트, 개인화 메시지를 효과적으로 전달할 수 있다

### US-10: 알림 발송 이력 추적
- **As a** 시스템 관리자
- **I want to** 발송한 알림의 성공/실패 건수와 상세 이력을 확인하고
- **So that** 알림 전달 품질을 모니터링하고 문제를 진단할 수 있다

## 사용자 시나리오

### 시나리오 1: 앱 최초 설치 후 알림 수신 설정 (정상 플로우)
1. 사용자가 앱을 설치하고 로그인한다
2. 시스템이 푸시 알림 권한을 요청한다 (iOS의 경우 시스템 다이얼로그)
3. 사용자가 권한을 허용한다
4. 앱이 디바이스 토큰을 획득하고 서버에 자동 등록한다
5. 결과: 사용자는 이제 푸시 알림을 받을 수 있다

### 시나리오 2: 백그라운드 상태에서 알림 수신 (정상 플로우)
1. 사용자가 앱을 홈 화면으로 나가거나 다른 앱을 사용한다
2. 서버에서 해당 사용자에게 푸시 알림을 발송한다
3. 디바이스가 알림을 수신하고 알림 센터에 표시한다
4. 사용자가 알림을 탭한다
5. 앱이 실행되고 알림과 관련된 화면으로 이동한다
6. 알림이 자동으로 읽음 처리된다
7. 결과: 사용자가 원하는 정보에 바로 접근할 수 있다

### 시나리오 3: 앱 사용 중 알림 수신 (포그라운드)
1. 사용자가 앱 내에서 특정 화면을 보고 있다
2. 서버에서 새로운 알림을 발송한다
3. 앱이 포그라운드 상태임을 감지하고 인앱 알림으로 표시한다
4. 사용자가 알림 배너를 탭하여 관련 화면으로 이동하거나 무시한다
5. 결과: 현재 작업을 방해하지 않으면서도 알림을 확인할 수 있다

### 시나리오 4: 앱 내 알림 목록 확인 (정상 플로우)
1. 사용자가 앱의 알림 목록 화면을 연다
2. 시스템이 최근 30일 이내 알림을 시간 역순으로 표시한다
3. 읽지 않은 알림은 굵은 글씨 또는 배지로 강조 표시된다
4. 사용자가 특정 알림을 탭한다
5. 알림이 읽음 처리되고 관련 화면으로 이동한다
6. 결과: 이전 알림을 다시 확인하고 놓친 정보를 파악할 수 있다

### 시나리오 5: 알림 읽음 처리 (정상 플로우)
1. 사용자가 알림 목록 화면에서 읽지 않은 알림을 확인한다
2. 사용자가 알림 항목을 탭한다
3. 시스템이 해당 알림을 읽음 상태로 변경한다
4. 시각적 강조 표시(배지, 굵은 글씨)가 제거된다
5. 읽지 않은 알림 카운트가 감소한다
6. 결과: 사용자가 확인한 알림과 미확인 알림을 쉽게 구분할 수 있다

### 시나리오 6: 앱 재설치 후 알림 재활성화 (정상 플로우)
1. 사용자가 앱을 삭제한다
2. 서버에서 해당 디바이스 토큰이 무효화된다
3. 사용자가 앱을 재설치하고 로그인한다
4. 시스템이 새로운 디바이스 토큰을 획득하고 서버에 등록한다
5. 결과: 사용자가 다시 푸시 알림을 받을 수 있다

### 시나리오 7: 관리자의 전체 사용자 공지 발송 (관리자 플로우)
1. 관리자가 공지사항 내용을 작성한다 (제목, 본문, 이미지, 딥링크 데이터)
2. 관리자가 대상을 '전체 사용자'로 설정하고 발송한다
3. 시스템이 활성 디바이스 토큰 목록을 조회한다
4. 시스템이 배치 단위로 알림을 발송한다
5. 발송 성공/실패 건수가 기록된다
6. 관리자가 발송 결과를 확인한다
7. 결과: 중요한 공지를 모든 사용자에게 전달할 수 있다

### 시나리오 8: 권한 거부 후 설정에서 활성화 (대안 플로우)
1. 사용자가 최초 알림 권한을 거부한다
2. 앱이 알림을 받을 수 없는 상태가 된다
3. 사용자가 나중에 알림을 받고 싶어한다
4. 앱 내 설정 화면에서 '알림 설정 열기' 버튼을 탭한다
5. 시스템 설정 화면으로 이동한다
6. 사용자가 알림 권한을 수동으로 활성화한다
7. 앱으로 돌아오면 자동으로 디바이스 토큰을 등록한다
8. 결과: 사용자가 나중에라도 알림을 활성화할 수 있다

## 인수 조건 (Acceptance Criteria)

### 디바이스 등록 및 권한
- [ ] 사용자가 로그인하면 자동으로 푸시 알림 권한을 요청한다
- [ ] 권한 허용 시 디바이스 토큰이 서버에 자동 등록된다
- [ ] 권한 거부 시에도 앱의 다른 기능은 정상 동작한다
- [ ] 권한 상태가 변경되면 자동으로 감지하고 토큰을 갱신한다
- [ ] 동일 사용자가 여러 디바이스에서 로그인하면 모든 디바이스에서 알림을 받을 수 있다

### 알림 수신 및 표시
- [ ] 백그라운드/종료 상태에서 알림이 시스템 알림 센터에 표시된다
- [ ] 포그라운드 상태에서 알림이 인앱 알림 형태로 표시된다
- [ ] 알림에 제목, 본문, 이미지(선택)가 정상 표시된다
- [ ] 알림을 탭하면 관련 화면으로 이동한다 (딥링크 처리)
- [ ] 알림 데이터가 없어도 앱이 정상 실행된다

### 알림 목록 및 읽음 상태
- [ ] 앱 내 알림 목록 화면에서 최근 알림을 시간 역순으로 볼 수 있다
- [ ] 읽지 않은 알림이 시각적으로 구분된다 (굵은 글씨, 배경색, 배지 등)
- [ ] 알림을 탭하면 자동으로 읽음 처리된다
- [ ] 읽은 알림은 시각적 강조가 제거된다
- [ ] 읽지 않은 알림 개수가 화면에 표시된다

### 알림 발송 (관리자/시스템)
- [ ] 특정 사용자 1명에게 알림을 발송할 수 있다
- [ ] 여러 사용자(목록)에게 동시에 알림을 발송할 수 있다
- [ ] 전체 사용자에게 알림을 발송할 수 있다
- [ ] 발송 시 제목, 본문은 필수이고 이미지와 커스텀 데이터는 선택이다
- [ ] 발송 결과(성공 건수, 실패 건수)가 기록된다

### 발송 이력 추적
- [ ] 관리자가 발송한 알림 목록을 조회할 수 있다
- [ ] 각 알림의 발송 시각, 대상 사용자, 성공/실패 건수를 확인할 수 있다
- [ ] 실패한 경우 에러 메시지를 확인할 수 있다

### 토큰 관리 및 안정성
- [ ] 무효한 디바이스 토큰은 자동으로 비활성화된다
- [ ] 비활성화된 토큰은 다음 발송 시 제외된다
- [ ] 앱 재설치나 토큰 갱신 시 자동으로 재등록된다
- [ ] 동일 디바이스에서 재등록 시 기존 토큰이 갱신된다 (중복 생성 방지)

## 엣지 케이스

- **권한이 거부된 상태에서 알림 발송**: 디바이스에 전달되지 않지만, 앱 내 알림 목록에는 기록되어야 한다
- **네트워크 오프라인 상태에서 토큰 등록 시도**: 로컬에 토큰을 임시 저장하고, 네트워크 복구 시 재시도해야 한다
- **앱 삭제 후 재설치 없이 서버에서 알림 발송**: 무효 토큰으로 인해 발송 실패하고 자동으로 비활성화되어야 한다
- **알림 목록 로딩 중 새 알림 도착**: 목록 상단에 새 알림이 자동 추가되거나 갱신 안내가 표시되어야 한다
- **관련 화면이 삭제된 딥링크 탭**: 기본 화면(홈)으로 이동하고 에러 메시지를 표시해야 한다
- **대량 발송(수천 명) 시 타임아웃**: 배치 단위로 처리하고 일부 실패해도 성공 건수는 정상 기록되어야 한다
- **동일 사용자가 5개 이상 디바이스 등록**: 모든 디바이스에 알림이 발송되어야 한다 (제한 없음)
- **알림 목록이 100개 이상일 때**: 페이지네이션 또는 무한 스크롤로 점진적으로 로드해야 한다
- **포그라운드에서 연속 알림 5개 수신**: 모든 알림이 표시되되, 화면을 방해하지 않도록 간결하게 표시해야 한다
- **알림 데이터에 잘못된 딥링크가 포함된 경우**: 앱이 크래시하지 않고 기본 화면으로 이동해야 한다

## 비즈니스 규칙

- **알림 보관 기간**: 앱 내 알림 목록은 최근 30일 이내 알림만 표시한다 (서버 데이터는 무제한 보관)
- **알림 우선순위**: 시스템 알림의 중요도는 알림 타입에 따라 설정한다 (긴급: High, 일반: Default, 프로모션: Low)
- **읽음 상태 초기값**: 새로 발송된 알림의 기본 읽음 상태는 '읽지 않음'이다
- **읽음 처리 시점**: 알림을 탭하거나 관련 화면에 진입하면 자동으로 읽음 처리된다
- **토큰 유효성**: 발송 실패 시 FCM이 반환하는 무효 토큰 에러 코드를 기준으로 자동 비활성화한다
- **발송 대상 결정**: 비활성화된 토큰과 권한이 없는 사용자는 발송 대상에서 제외한다
- **배치 발송 단위**: 한 번에 최대 500개 디바이스까지 발송한다 (FCM API 제약)
- **재시도 정책**: 발송 실패 시 즉시 재시도하지 않고 실패로 기록한다 (관리자가 수동 재발송 가능)
- **알림 내용 제한**: 제목은 최대 255자, 본문은 최대 1000자, 이미지 URL은 최대 500자로 제한한다
- **개인정보 보호**: 알림 내용에 민감한 개인정보(비밀번호, 카드번호 등)가 포함되어서는 안 된다
- **앱별 데이터 격리**: 알림 수신 기록, 알림 목록 조회, 읽음 처리 등 모든 사용자 대상 기능은 appCode로 앱을 구분하여 해당 앱의 알림만 접근 가능해야 한다

## 필요한 데이터

### 디바이스 등록 정보
| 데이터 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| userId | Integer | ✅ | 사용자 식별자 |
| token | String | ✅ | FCM 디바이스 토큰 |
| platform | Enum | ✅ | ios / android / web |
| deviceId | String | ❌ | 디바이스 고유 식별자 (선택) |

### 알림 발송 요청
| 데이터 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| title | String | ✅ | 알림 제목 (최대 255자) |
| body | String | ✅ | 알림 본문 (최대 1000자) |
| imageUrl | String | ❌ | 이미지 URL (최대 500자) |
| data | Object | ❌ | 딥링크 및 커스텀 데이터 (JSON) |
| targetType | Enum | ✅ | single / multiple / all |
| userId | Integer | ❌ | 단건 발송 시 대상 사용자 ID |
| userIds | Array<Integer> | ❌ | 다건 발송 시 대상 사용자 ID 목록 |

### 알림 수신 데이터
| 데이터 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| notificationId | Integer | ✅ | 알림 고유 식별자 |
| appCode | String | ✅ | 앱 식별 코드 (앱별 알림 격리) |
| userId | Integer | ✅ | 수신 사용자 ID |
| title | String | ✅ | 알림 제목 |
| body | String | ✅ | 알림 본문 |
| imageUrl | String | ❌ | 이미지 URL |
| data | Object | ❌ | 딥링크 및 커스텀 데이터 |
| isRead | Boolean | ✅ | 읽음 상태 |
| receivedAt | Timestamp | ✅ | 수신 시각 |

### 알림 목록 조회
| 데이터 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| appCode | String | ✅ | 앱 식별 코드 (해당 앱의 알림만 조회) |
| limit | Integer | ❌ | 페이지 크기 (기본값: 20) |
| offset | Integer | ❌ | 페이지 오프셋 (기본값: 0) |
| unreadOnly | Boolean | ❌ | 읽지 않은 알림만 조회 여부 (기본값: false) |

### 알림 읽음 처리
| 데이터 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| notificationId | Integer | ✅ | 읽음 처리할 알림 ID |
| userId | Integer | ✅ | 사용자 ID (인증 토큰에서 추출) |

## 비기능 요구사항

### 성능
- **디바이스 토큰 등록**: 3초 이내 완료 (네트워크 정상 상태)
- **알림 발송 응답**: 단건 1초 이내, 다건 500명 기준 10초 이내
- **알림 목록 조회**: 20개 기준 1초 이내 응답
- **읽음 처리**: 0.5초 이내 완료
- **포그라운드 알림 표시**: 수신 후 1초 이내 화면 표시

### 접근성
- **알림 권한 안내**: 권한 요청 전 사용자에게 알림의 가치를 명확히 안내해야 한다
- **시각적 구분**: 읽지 않은 알림은 색상/굵기/배지 등으로 명확히 구분되어야 한다
- **스크린 리더 지원**: 알림 목록의 각 항목에 접근성 레이블이 제공되어야 한다
- **큰 텍스트 지원**: 시스템 글꼴 크기 설정을 반영해야 한다

### 에러 처리
- **네트워크 오류**: "네트워크 연결을 확인해 주세요" 메시지를 표시하고 재시도 버튼을 제공한다
- **권한 거부**: "알림을 받으려면 설정에서 권한을 허용해 주세요" 안내와 설정 화면 이동 버튼을 제공한다
- **토큰 등록 실패**: 자동 재시도하고, 지속 실패 시 로그만 기록한다 (사용자에게 노출하지 않음)
- **발송 실패 (관리자)**: 실패 건수와 에러 메시지를 명확히 표시한다
- **알림 목록 로딩 실패**: "알림을 불러올 수 없습니다" 메시지와 재시도 버튼을 표시한다
- **잘못된 딥링크**: 앱이 크래시하지 않고 홈 화면으로 이동하며 "페이지를 찾을 수 없습니다" 메시지를 표시한다

### 보안
- **토큰 보안**: 디바이스 토큰은 서버에서만 관리하고 클라이언트는 노출하지 않는다
- **인증 필수**: 알림 목록 조회 및 읽음 처리는 인증된 사용자만 가능하다
- **권한 검증**: 다른 사용자의 알림을 조회하거나 읽음 처리할 수 없다
- **민감 정보 제외**: 알림 본문에 비밀번호, 카드번호 등 민감 정보를 포함하지 않는다

### 데이터 정합성
- **읽음 상태 동기화**: 알림 탭 시 서버와 로컬 상태가 동기화되어야 한다
- **중복 방지**: 동일 디바이스 토큰 재등록 시 중복 생성이 아닌 갱신 처리되어야 한다
- **알림 순서**: 알림 목록은 수신 시간 역순으로 정렬되어야 한다
- **카운트 일관성**: 읽지 않은 알림 개수가 실제 데이터와 일치해야 한다
